<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>記帳 | 東京 6 日</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        .accounting-container {
            max-width: 900px;
            margin: 60px auto;
            padding: 0 24px;
        }

        .accounting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 48px;
        }

        .accounting-header h1 {
            font-size: 2.5rem;
            color: var(--accent);
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
            color: var(--accent);
            font-weight: 500;
        }

        .logout-btn {
            padding: 10px 24px;
            background: var(--white);
            border: 1px solid var(--sand);
            border-radius: 999px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--accent);
            font-weight: 600;
            transition: all 0.2s ease;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .logout-btn:hover {
            background: var(--accent);
            color: var(--white);
            box-shadow: var(--shadow-sm);
        }

        .add-expense-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 32px;
            background: var(--accent);
            color: var(--white);
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: 'Noto Sans TC', sans-serif;
            box-shadow: var(--shadow-md);
            margin-bottom: 32px;
        }

        .add-expense-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .add-expense-btn::before {
            content: '+';
            font-size: 1.5rem;
            font-weight: 700;
        }



        .expense-list {
            background: var(--white);
            border-radius: 24px;
            border: 1px solid var(--sand);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 32px;
            border-bottom: 1px solid var(--shell);
            transition: background 0.2s ease;
        }

        .expense-item:hover {
            background: var(--linen);
        }

        .expense-item:last-child {
            border-bottom: none;
        }

        .expense-info {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .expense-date {
            color: var(--text);
            opacity: 0.6;
            font-size: 0.9rem;
            width: 100px;
            font-weight: 500;
        }

        .expense-name {
            font-weight: 600;
            color: var(--accent);
            font-size: 1rem;
        }

        .expense-amount {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .currency-twd {
            color: #2e7d32;
        }

        .currency-jpy {
            color: #1565c0;
        }

        .empty-state {
            padding: 60px 40px;
            text-align: center;
            color: var(--text);
            opacity: 0.5;
            font-size: 1rem;
        }

        /* Navbar styles are inherited from style.css */
    </style>
</head>

<body>
    <div id="app" v-cloak>
        <!-- Navbar -->
        <nav class="sticky-nav nav-bottom">
            <div class="nav-pill">
                <a href="index.html" class="nav-item">首頁</a>
                <a href="weather.html" class="nav-item">天氣</a>
                <a href="accounting.html" class="nav-item active">記帳</a>
            </div>
        </nav>

        <div class="accounting-container">
            <div class="accounting-header">
                <h1>旅費記帳</h1>
                <div class="user-info" v-if="user">
                    <span>{{ user.username }}</span>
                    <button class="logout-btn" @click="logout">登出</button>
                </div>
            </div>

            <!-- 新增記帳按鈕 -->
            <button class="add-expense-btn" @click="showAddExpenseModal">
                新增一筆
            </button>

            <!-- 記帳列表 -->
            <div class="expense-list">
                <div v-if="expenses.length === 0" class="empty-state">
                    目前沒有記帳紀錄
                </div>
                <div v-else v-for="expense in expenses" :key="expense.id" class="expense-item">
                    <div class="expense-info">
                        <div class="expense-date">
                            <div>{{ formatDate(expense.date) }}</div>
                            <div style="font-size: 12px; color: #aaa;">{{ formatTime(expense.time) }}</div>
                        </div>
                        <div class="expense-name">{{ expense.item_name }}</div>
                    </div>
                    <div class="expense-amount" :class="expense.currency === 'TWD' ? 'currency-twd' : 'currency-jpy'">
                        {{ expense.currency === 'TWD' ? 'NT$' : '¥' }} {{ formatNumber(expense.amount) }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vue 2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    <script src="js/api-service.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        new Vue({
            el: '#app',
            data: {
                user: null,
                loading: false,
                expenses: [],
                form: {
                    date: '',
                    time: '',
                    itemName: '',
                    amount: '',
                    currency: 'JPY'
                }
            },
            mounted() {
                this.checkLogin();
                this.setDefaultDateTime();
            },
            methods: {
                checkLogin() {
                    const userStr = localStorage.getItem('user');
                    if (!userStr) {
                        window.location.href = 'login.html?redirect=accounting.html';
                        return;
                    }
                    this.user = JSON.parse(userStr);
                    this.loadExpenses();
                },
                setDefaultDateTime() {
                    const now = new Date();
                    this.form.date = now.toISOString().split('T')[0];
                    this.form.time = now.toTimeString().slice(0, 5);
                },
                async loadExpenses() {
                    try {
                        const result = await ExpenseAPI.getAll(this.user.id);
                        if (result.success) {
                            this.expenses = result.data;
                        }
                    } catch (error) {
                        console.error('Failed to load expenses:', error);
                    }
                },
                async showAddExpenseModal() {
                    this.setDefaultDateTime();

                    const { value: formValues } = await Swal.fire({
                        title: '新增記帳',
                        html: `
                            <div style="text-align: left;">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--accent);">日期</label>
                                    <input id="swal-date" type="date" class="swal2-input" value="${this.form.date}" style="width: 90%; margin: 0;">
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--accent);">時間</label>
                                    <input id="swal-time" type="time" class="swal2-input" value="${this.form.time}" style="width: 90%; margin: 0;">
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--accent);">名稱</label>
                                    <input id="swal-name" type="text" class="swal2-input" placeholder="例如：午餐、車票" style="width: 90%; margin: 0;">
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--accent);">金額</label>
                                    <input id="swal-amount" type="number" class="swal2-input" min="0" step="0.01" placeholder="0.00" style="width: 90%; margin: 0;">
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--accent);">幣別</label>
                                    <select id="swal-currency" class="swal2-input" style="width: 90%; margin: 0;">
                                        <option value="JPY" selected>日圓 (JPY)</option>
                                        <option value="TWD">新台幣 (TWD)</option>
                                    </select>
                                </div>
                            </div>
                        `,
                        focusConfirm: false,
                        showCancelButton: true,
                        confirmButtonText: '新增',
                        cancelButtonText: '取消',
                        confirmButtonColor: '#4A2F1E',
                        cancelButtonColor: '#999',
                        width: '500px',
                        preConfirm: () => {
                            const date = document.getElementById('swal-date').value;
                            const time = document.getElementById('swal-time').value;
                            const name = document.getElementById('swal-name').value;
                            const amount = document.getElementById('swal-amount').value;
                            const currency = document.getElementById('swal-currency').value;

                            if (!date || !time || !name || !amount) {
                                Swal.showValidationMessage('請填寫所有欄位');
                                return false;
                            }

                            return { date, time, name, amount, currency };
                        }
                    });

                    if (formValues) {
                        this.form.date = formValues.date;
                        this.form.time = formValues.time;
                        this.form.itemName = formValues.name;
                        this.form.amount = formValues.amount;
                        this.form.currency = formValues.currency;
                        await this.addExpense();
                    }
                },
                async addExpense() {
                    this.loading = true;
                    try {
                        const result = await ExpenseAPI.create(
                            this.user.id,
                            this.form.date,
                            this.form.time,
                            this.form.itemName,
                            this.form.amount,
                            this.form.currency
                        );

                        if (result.success) {
                            await this.loadExpenses();
                            this.form.itemName = '';
                            this.form.amount = '';
                            this.setDefaultDateTime();

                            // 顯示成功訊息
                            Swal.fire({
                                icon: 'success',
                                title: '新增成功！',
                                text: '記帳紀錄已儲存',
                                timer: 1500,
                                showConfirmButton: false
                            });
                        }
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: '新增失敗',
                            text: error.message
                        });
                    } finally {
                        this.loading = false;
                    }
                },
                logout() {
                    localStorage.removeItem('user');
                    window.location.href = 'login.html?redirect=accounting.html';
                },
                formatDate(dateStr) {
                    return new Date(dateStr).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
                },
                formatTime(timeStr) {
                    return timeStr.slice(0, 5);
                },
                formatNumber(num) {
                    return Number(num).toLocaleString();
                }
            }
        });
    </script>
</body>

</html>