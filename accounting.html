<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ë®òÂ∏≥ | Êù±‰∫¨ 6 Êó•</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        /* Override body padding for this page */
        body {
            padding-top: 40px;
            background: linear-gradient(135deg, #faf8f5 0%, #f5f1eb 100%);
            min-height: 100vh;
        }

        .accounting-container {
            max-width: 900px;
            margin: 0 auto 60px;
            padding: 0 24px;
            position: relative;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .accounting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 48px;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .accounting-header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #4A2F1E 0%, #8B6F47 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(74, 47, 30, 0.1);
            animation: titleGlow 3s ease-in-out infinite;
        }

        @keyframes titleGlow {

            0%,
            100% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(1.1);
            }
        }

        .header-controls {
            margin-bottom: 32px;
            animation: slideDown 0.6s ease-out 0.2s backwards;
        }

        .refresh-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #ffffff 0%, #faf8f5 100%);
            border: 2px solid var(--sand);
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--accent);
            box-shadow: 0 2px 8px rgba(74, 47, 30, 0.1),
                0 1px 3px rgba(74, 47, 30, 0.08);
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .refresh-btn:hover {
            background: linear-gradient(135deg, #4A2F1E 0%, #8B6F47 100%);
            color: white;
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(74, 47, 30, 0.25),
                0 2px 8px rgba(74, 47, 30, 0.15);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        .refresh-btn.refreshing {
            pointer-events: none;
            opacity: 0.6;
        }

        .refresh-btn.refreshing svg {
            animation: spin 1s linear infinite;
        }

        .refresh-text {
            display: inline;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .accounting-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
                margin-bottom: 24px;
            }

            .accounting-header h1 {
                font-size: 1.8rem;
            }

            .header-controls {
                margin-bottom: 24px;
            }

            .refresh-btn {
                padding: 8px 16px;
                font-size: 0.85rem;
            }

            .user-info {
                width: 100%;
                justify-content: space-between;
                gap: 12px;
                margin-bottom: 5%;
            }

            .user-info span {
                font-size: 0.9rem;
            }

            .logout-btn {
                padding: 8px 20px;
                font-size: 0.85rem;
            }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
            color: var(--accent);
            font-weight: 500;
        }

        .logout-btn {
            padding: 10px 24px;
            background: linear-gradient(135deg, #ffffff 0%, #faf8f5 100%);
            border: 2px solid var(--sand);
            border-radius: 999px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--accent);
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Noto Sans TC', sans-serif;
            box-shadow: 0 2px 8px rgba(74, 47, 30, 0.1),
                0 1px 3px rgba(74, 47, 30, 0.08);
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #4A2F1E 0%, #8B6F47 100%);
            color: var(--white);
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 47, 30, 0.25),
                0 3px 10px rgba(74, 47, 30, 0.15);
        }

        .logout-btn:active {
            transform: translateY(0);
        }

        .add-expense-btn {
            position: fixed;
            bottom: 100px;
            right: 32px;
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #4A2F1E 0%, #8B6F47 100%);
            color: var(--white);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 2rem;
            font-weight: 300;
            font-family: 'Noto Sans TC', sans-serif;
            box-shadow: 0 8px 24px rgba(74, 47, 30, 0.35),
                0 4px 12px rgba(74, 47, 30, 0.25);
            z-index: 50;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .add-expense-btn:hover {
            transform: scale(1.15) rotate(90deg);
            box-shadow: 0 12px 40px rgba(74, 47, 30, 0.45),
                0 6px 20px rgba(74, 47, 30, 0.35);
        }

        .add-expense-btn:active {
            transform: scale(0.95);
        }

        /* ÊâãÊ©üÁâàË™øÊï¥ */
        @media (max-width: 768px) {
            .add-expense-btn {
                bottom: 80px;
                right: 20px;
                width: 56px;
                height: 56px;
                font-size: 1.8rem;
            }
        }



        .expense-list {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .day-group {
            background: linear-gradient(135deg, #ffffff 0%, #fefefe 100%);
            border-radius: 24px;
            border: 1px solid rgba(212, 193, 165, 0.3);
            box-shadow: 0 4px 20px rgba(74, 47, 30, 0.08),
                0 2px 8px rgba(74, 47, 30, 0.05),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: cardSlideIn 0.5s ease-out backwards;
        }

        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ÁÇ∫ÊØèÂÄãÂç°ÁâáÊ∑ªÂä†Âª∂ÈÅ≤ÂãïÁï´ */
        .day-group:nth-child(1) {
            animation-delay: 0.1s;
        }

        .day-group:nth-child(2) {
            animation-delay: 0.2s;
        }

        .day-group:nth-child(3) {
            animation-delay: 0.3s;
        }

        .day-group:nth-child(4) {
            animation-delay: 0.4s;
        }

        .day-group:nth-child(5) {
            animation-delay: 0.5s;
        }

        .day-group:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 12px 40px rgba(74, 47, 30, 0.15),
                0 6px 20px rgba(74, 47, 30, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.8) inset;
            border-color: rgba(212, 193, 165, 0.5);
        }

        .day-header {
            background: linear-gradient(135deg, #F5EFE6 0%, #FAF8F5 100%);
            padding: 16px 28px;
            border-bottom: 2px solid rgba(212, 193, 165, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .day-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(139, 111, 71, 0.3) 50%,
                    transparent 100%);
        }

        .day-date {
            display: flex;
            align-items: baseline;
            gap: 12px;
        }

        .day-date-main {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent);
        }

        .day-date-weekday {
            font-size: 0.9rem;
            color: var(--text);
            opacity: 0.6;
            font-weight: 500;
        }

        .day-count {
            font-size: 0.85rem;
            color: var(--accent);
            opacity: 0.7;
            font-weight: 600;
        }


        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 28px;
            border-bottom: 1px solid rgba(245, 239, 230, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .expense-item:last-child {
            border-bottom: none;
        }

        .expense-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(135deg, #4A2F1E 0%, #8B6F47 100%);
            transform: scaleY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .expense-item:hover {
            background: linear-gradient(90deg,
                    rgba(250, 248, 245, 0.5) 0%,
                    rgba(245, 239, 230, 0.3) 100%);
            transform: translateX(4px);
        }

        .expense-item:hover::before {
            transform: scaleY(1);
        }

        .expense-info {
            display: flex;
            gap: 24px;
            align-items: center;
            flex: 1;
        }

        .expense-time {
            color: var(--text);
            opacity: 0.5;
            font-size: 0.85rem;
            font-weight: 500;
            font-family: monospace;
            min-width: 50px;
            transition: all 0.3s ease;
        }

        .expense-item:hover .expense-time {
            opacity: 0.7;
            transform: translateX(2px);
        }

        .expense-name {
            font-weight: 600;
            color: var(--accent);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .expense-item:hover .expense-name {
            color: #8B6F47;
        }

        .expense-amount {
            font-weight: 700;
            font-size: 1.1rem;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .expense-item:hover .expense-amount {
            transform: scale(1.05);
        }

        .currency-twd {
            color: #2e7d32;
            background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .currency-jpy {
            color: #1565c0;
            background: linear-gradient(135deg, #1565c0 0%, #1976d2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .expense-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .delete-btn {
            background: transparent;
            border: none;
            color: #e53e3e;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            transform: translateX(10px) scale(0.8);
        }

        .expense-item:hover .delete-btn {
            opacity: 1;
            transform: translateX(0) scale(1);
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            transform: translateX(0) scale(1.1) rotate(10deg);
            box-shadow: 0 2px 8px rgba(229, 62, 62, 0.2);
        }

        .delete-btn:active {
            transform: translateX(0) scale(0.9);
        }

        /* SweetAlert2 Customization */
        .swal2-popup {
            border-radius: 24px !important;
        }

        .swal2-input,
        .swal2-select {
            border-radius: 12px !important;
        }

        .swal2-confirm,
        .swal2-cancel {
            border-radius: 12px !important;
        }

        /* Swipe to Delete Styles */
        .expense-item-wrapper {
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid var(--shell);
        }

        .expense-item-wrapper:last-child {
            border-bottom: none;
        }

        .expense-item {
            position: relative;
            z-index: 2;
            background: var(--white);
            transition: transform 0.2s ease-out;
            border-bottom: none;
            /* Moved to wrapper */
        }

        .swipe-delete-action {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            width: 80px;
            background: #e53e3e;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            z-index: 1;
        }

        /* Hide desktop delete button on mobile if swiped */
        @media (max-width: 768px) {
            .delete-btn {
                display: none;
            }
        }

        /* Day Summary */
        .day-summary {
            background: linear-gradient(135deg, #FAF8F5 0%, #F5EFE6 100%);
            padding: 16px 28px;
            border-top: 2px solid rgba(212, 193, 165, 0.3);
            display: flex;
            gap: 40px;
            justify-content: flex-end;
            position: relative;
            overflow: hidden;
        }

        .day-summary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(139, 111, 71, 0.2) 50%,
                    transparent 100%);
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            transition: transform 0.3s ease;
        }

        .summary-item:hover {
            transform: scale(1.05);
        }

        .summary-label {
            font-size: 0.8rem;
            color: var(--text);
            opacity: 0.6;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .summary-amount {
            font-size: 1.3rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .summary-item:hover .summary-amount {
            transform: scale(1.1);
            filter: brightness(1.1);
        }

        .summary-amount.jpy {
            background: linear-gradient(135deg, #1565c0 0%, #1976d2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .summary-amount.twd {
            background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .empty-state {
            padding: 60px 40px;
            text-align: center;
            color: var(--text);
            opacity: 0.5;
            font-size: 1rem;
        }

        /* Loading Spinner */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 40px;
            gap: 20px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--shell);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: var(--accent);
            font-size: 0.95rem;
            font-weight: 500;
            opacity: 0.7;
        }

        /* Navbar styles are inherited from style.css */
    </style>
</head>

<body>
    <div id="app" v-cloak>
        <!-- Navbar -->
        <nav class="sticky-nav nav-bottom">
            <div class="nav-pill">
                <a href="index.html" class="nav-item">È¶ñÈ†Å</a>
                <a href="weather.html" class="nav-item">Â§©Ê∞£</a>
                <a href="accounting.html" class="nav-item active">Ë®òÂ∏≥</a>
            </div>
        </nav>

        <div class="accounting-container">
            <div class="user-info">
                <h1>ÊóÖË≤ªË®òÂ∏≥</h1>
                <div v-if="user">
                    <button class="logout-btn" @click="logout">ÁôªÂá∫</button>
                </div>
            </div>

            <div class="header-controls">
                <button class="refresh-btn" :class="{ refreshing: isRefreshing }" @click="refreshExpenses"
                    title="ÈáçÊñ∞ËºâÂÖ•Ë®òÂ∏≥Ë≥áÊñô">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                    <span class="refresh-text">ÈáçÊñ∞Êï¥ÁêÜ</span>
                </button>
            </div>

            <!-- Ë®òÂ∏≥ÂàóË°® -->
            <div v-if="!isLoading && expenses.length > 0">
                <div v-for="(group, date) in expensesByDate" :key="date" class="day-group">
                    <!-- Êó•ÊúüÊ®ôÈ°å -->
                    <div class="day-header">
                        <div class="day-date">
                            <div class="day-date-main">{{ formatDateFull(date) }}</div>
                            <div class="day-date-weekday">{{ formatWeekday(date) }}</div>
                        </div>
                        <div class="day-count">{{ group.items.length }} Á≠Ü</div>
                    </div>

                    <!-- Ë®òÂ∏≥È†ÖÁõÆ -->
                    <div class="expense-items">
                        <div v-for="expense in group.items" :key="expense.id" class="expense-item-wrapper">
                            <!-- Â∑¶ÊªëÂá∫ÁèæÁöÑÂà™Èô§ÊåâÈàï -->
                            <div class="swipe-delete-action" @click="deleteExpense(expense.id)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                </svg>
                            </div>

                            <!-- ‰∏ªË¶ÅÂÖßÂÆπ -->
                            <div class="expense-item"
                                :style="{ transform: activeSwipeId === expense.id ? 'translateX(-80px)' : 'translateX(0)' }"
                                @touchstart="handleTouchStart($event, expense.id)" @touchend="handleTouchEnd($event)"
                                @click="handleItemClick(expense.id)">
                                <div class="expense-info">
                                    <div class="expense-time">{{ formatTime(expense.time) }}</div>
                                    <div class="expense-name">{{ expense.item_name }}</div>
                                </div>
                                <div class="expense-actions">
                                    <div class="expense-amount"
                                        :class="expense.currency === 'TWD' ? 'currency-twd' : 'currency-jpy'">
                                        {{ expense.currency === 'TWD' ? 'NT$' : '¬•' }} {{ formatNumber(expense.amount)
                                        }}
                                    </div>
                                    <button class="delete-btn" @click.stop="deleteExpense(expense.id)" title="Âà™Èô§">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path
                                                d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Áï∂Êó•Á∏ΩË®à -->
                    <div class="day-summary">
                        <div v-if="group.totalJPY > 0" class="summary-item">
                            <div class="summary-label">Êó•ÂúìÁ∏ΩË®à</div>
                            <div class="summary-amount jpy">¬• {{ formatNumber(group.totalJPY) }}</div>
                        </div>
                        <div v-if="group.totalTWD > 0" class="summary-item">
                            <div class="summary-label">Âè∞Âπ£Á∏ΩË®à</div>
                            <div class="summary-amount twd">NT$ {{ formatNumber(group.totalTWD) }}</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Loading ÈÅÆÁΩ© -->
            <div v-if="isLoading" class="loading-overlay">
                <div class="spinner"></div>
                <div class="loading-text">ËºâÂÖ•‰∏≠...</div>
            </div>

            <!-- Á©∫ÁãÄÊÖã -->
            <div v-else-if="expenses.length === 0" class="day-group">
                <div class="empty-state">
                    ÁõÆÂâçÊ≤íÊúâË®òÂ∏≥Á¥ÄÈåÑ
                </div>
            </div>
        </div>

        <!-- Êñ∞Â¢ûË®òÂ∏≥ÊåâÈàï (FAB) -->
        <button class="add-expense-btn" @click="showAddExpenseModal" title="Êñ∞Â¢û‰∏ÄÁ≠ÜË®òÂ∏≥">
            +
        </button>
    </div>

    <!-- Vue 2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    <script src="js/api-service.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        new Vue({
            el: '#app',
            data: {
                user: null,
                loading: false,
                isLoading: false,
                isRefreshing: false,
                expenses: [],
                form: {
                    date: '',
                    time: '',
                    itemName: '',
                    amount: '',
                    currency: 'JPY'
                },
                // Ëß∏ÊéßÊªëÂãïÁõ∏Èóú
                touchStartX: 0,
                touchStartY: 0,
                currentTouchId: null,
                activeSwipeId: null,
                // Âø´ÂèñÁõ∏Èóú
                cacheKey: 'accounting_expenses_cache',
                cacheExpireTime: 5 * 60 * 1000, // Âø´ÂèñÈÅéÊúüÊôÇÈñìÔºö5ÂàÜÈêò
                isLoadingFromCache: false
            },
            mounted() {
                this.checkLogin();
                this.setDefaultDateTime();
            },
            computed: {
                /**
                 * ÊåâÊó•ÊúüÂàÜÁµÑÁöÑË®òÂ∏≥Ë≥áÊñô
                 */
                expensesByDate() {
                    const grouped = {};

                    // ÊåâÊó•ÊúüÂàÜÁµÑ
                    this.expenses.forEach(expense => {
                        const date = expense.date;
                        if (!grouped[date]) {
                            grouped[date] = {
                                items: [],
                                totalJPY: 0,
                                totalTWD: 0
                            };
                        }
                        grouped[date].items.push(expense);

                        // Ë®àÁÆóÁ∏ΩË®à
                        if (expense.currency === 'JPY') {
                            grouped[date].totalJPY += parseFloat(expense.amount);
                        } else if (expense.currency === 'TWD') {
                            grouped[date].totalTWD += parseFloat(expense.amount);
                        }
                    });

                    // ÊåâÊó•ÊúüÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
                    const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
                    const result = {};
                    sortedDates.forEach(date => {
                        result[date] = grouped[date];
                    });

                    return result;
                }
            },
            methods: {
                checkLogin() {
                    const userStr = localStorage.getItem('user');
                    if (!userStr) {
                        window.location.href = 'login.html?redirect=accounting.html';
                        return;
                    }
                    this.user = JSON.parse(userStr);
                    this.loadExpenses();
                },
                setDefaultDateTime() {
                    const now = new Date();
                    this.form.date = now.toISOString().split('T')[0];
                    this.form.time = now.toTimeString().slice(0, 5);
                },
                async loadExpenses(forceRefresh = false) {
                    // Âø´ÂèñÂÑ™ÂÖàÁ≠ñÁï•ÔºöÂÖàÂæûÂø´ÂèñËºâÂÖ•ÔºåÂÜçÂæû API Êõ¥Êñ∞
                    const cachedData = this.getCachedExpenses();

                    if (cachedData && !forceRefresh) {
                        // ‰ΩøÁî®Âø´ÂèñË≥áÊñôÁ´ãÂç≥È°ØÁ§∫
                        this.expenses = cachedData.data;
                        this.isLoadingFromCache = true;
                        console.log('üì¶ ÂæûÂø´ÂèñËºâÂÖ•Ë®òÂ∏≥Ë≥áÊñô');

                        // Ê™¢Êü•Âø´ÂèñÊòØÂê¶ÈÅéÊúü
                        const cacheAge = Date.now() - cachedData.timestamp;
                        if (cacheAge < this.cacheExpireTime) {
                            console.log(`‚úÖ Âø´Âèñ‰ªçÁÑ∂ÊúâÊïà (${Math.round(cacheAge / 1000)}ÁßíÂâç)`);
                            // Âø´Âèñ‰ªçÁÑ∂ÊúâÊïàÔºå‰ΩÜ‰ªçÂú®ËÉåÊôØÊõ¥Êñ∞
                        } else {
                            console.log(`‚ö†Ô∏è Âø´ÂèñÂ∑≤ÈÅéÊúü (${Math.round(cacheAge / 1000)}ÁßíÂâç)`);
                        }
                    } else {
                        this.isLoading = true;
                    }

                    // Âæû API Áç≤ÂèñÊúÄÊñ∞Ë≥áÊñôÔºàËÉåÊôØÊõ¥Êñ∞ÊàñÈ¶ñÊ¨°ËºâÂÖ•Ôºâ
                    try {
                        const result = await ExpenseAPI.getAll(this.user.id);
                        if (result.success) {
                            this.expenses = result.data;
                            // Êõ¥Êñ∞Âø´Âèñ
                            this.saveCachedExpenses(result.data);
                            console.log('üîÑ Â∑≤Âæû API Êõ¥Êñ∞Ë®òÂ∏≥Ë≥áÊñô‰∏¶ÂÑ≤Â≠òËá≥Âø´Âèñ');
                        }
                    } catch (error) {
                        console.error('Failed to load expenses:', error);
                        // Â¶ÇÊûúÊúâÂø´ÂèñË≥áÊñôÔºåÂâá‰ΩøÁî®Âø´ÂèñË≥áÊñôÔºå‰∏çÈ°ØÁ§∫ÈåØË™§
                        if (!cachedData) {
                            Swal.fire({
                                icon: 'error',
                                title: 'ËºâÂÖ•Â§±Êïó',
                                text: 'ÁÑ°Ê≥ïËºâÂÖ•Ë®òÂ∏≥Á¥ÄÈåÑÔºåË´ãÁ®çÂæåÂÜçË©¶'
                            });
                        } else {
                            console.log('‚ö†Ô∏è API ËºâÂÖ•Â§±ÊïóÔºå‰ΩøÁî®Âø´ÂèñË≥áÊñô');
                        }
                    } finally {
                        this.isLoading = false;
                        this.isLoadingFromCache = false;
                    }
                },
                /**
                 * ÂÑ≤Â≠òË®òÂ∏≥Ë≥áÊñôËá≥Âø´Âèñ
                 */
                saveCachedExpenses(data) {
                    try {
                        const cacheData = {
                            data: data,
                            timestamp: Date.now(),
                            userId: this.user.id
                        };
                        localStorage.setItem(this.cacheKey, JSON.stringify(cacheData));
                    } catch (error) {
                        console.error('Failed to save cache:', error);
                    }
                },
                /**
                 * ÂæûÂø´ÂèñËÆÄÂèñË®òÂ∏≥Ë≥áÊñô
                 */
                getCachedExpenses() {
                    try {
                        const cached = localStorage.getItem(this.cacheKey);
                        if (!cached) return null;

                        const cacheData = JSON.parse(cached);

                        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Âêå‰∏Ä‰ΩøÁî®ËÄÖÁöÑÂø´Âèñ
                        if (cacheData.userId !== this.user.id) {
                            console.log('üîÑ ‰ΩøÁî®ËÄÖÂ∑≤ËÆäÊõ¥ÔºåÊ∏ÖÈô§ËàäÂø´Âèñ');
                            this.clearCache();
                            return null;
                        }

                        return cacheData;
                    } catch (error) {
                        console.error('Failed to read cache:', error);
                        return null;
                    }
                },
                /**
                 * Ê∏ÖÈô§Âø´Âèñ
                 */
                clearCache() {
                    try {
                        localStorage.removeItem(this.cacheKey);
                        console.log('üóëÔ∏è Â∑≤Ê∏ÖÈô§Âø´Âèñ');
                    } catch (error) {
                        console.error('Failed to clear cache:', error);
                    }
                },
                /**
                 * ÊâãÂãïÂà∑Êñ∞Ë®òÂ∏≥Ë≥áÊñô
                 */
                async refreshExpenses() {
                    this.isRefreshing = true;
                    console.log('üîÑ ÊâãÂãïÂà∑Êñ∞Ë®òÂ∏≥Ë≥áÊñô...');
                    try {
                        // Âº∑Âà∂Âæû API ÈáçÊñ∞ËºâÂÖ•ÔºåÂøΩÁï•Âø´Âèñ
                        await this.loadExpenses(true);
                    } catch (error) {
                        console.error('Refresh failed:', error);
                    } finally {
                        // Âª∂ÈÅ≤‰∏ÄÈªûÂÜçÁßªÈô§ÂãïÁï´ÔºåËÆì‰ΩøÁî®ËÄÖÁúãÂà∞ÂÆåÊï¥ÁöÑÊóãËΩâÊïàÊûú
                        setTimeout(() => {
                            this.isRefreshing = false;
                        }, 500);
                    }
                },
                async showAddExpenseModal() {
                    this.setDefaultDateTime();

                    const { value: formValues } = await Swal.fire({
                        title: '',
                        html: `
                            <div style="text-align: left; font-size: 0.9rem;">
                                <style>
                                    .swal2-input {
                                        height: 2.2em !important;
                                        padding: 0 0.75em !important;
                                        font-size: 0.95rem !important;
                                        margin: 0 !important;
                                        width: 100% !important;
                                        box-sizing: border-box !important;
                                        max-width: 100% !important;
                                    }
                                    .date-time-grid {
                                        display: grid;
                                        grid-template-columns: 1fr 1fr;
                                        gap: 8px;
                                        margin-bottom: 12px;
                                    }
                                    @media (max-width: 500px) {
                                        .swal2-input {
                                            font-size: 0.85rem !important;
                                            padding: 0 0.5em !important;
                                        }
                                        .date-time-grid {
                                            gap: 6px;
                                        }
                                    }
                                    .num-pad-grid {
                                        display: grid;
                                        grid-template-columns: repeat(3, 1fr);
                                        gap: 8px;
                                        margin-top: 8px;
                                    }
                                    .num-btn {
                                        padding: 10px;
                                        font-size: 1.2rem;
                                        font-weight: 500;
                                        border: 1px solid var(--sand);
                                        border-radius: 8px;
                                        background: var(--white);
                                        color: var(--accent);
                                        cursor: pointer;
                                        transition: background 0.1s;
                                        user-select: none;
                                    }
                                    .num-btn:active {
                                        background: var(--linen);
                                        transform: scale(0.98);
                                    }
                                    .num-btn.action-btn {
                                        background: var(--shell);
                                        font-size: 1rem;
                                    }
                                    .swal2-actions {
                                        position: sticky;
                                        bottom: 0;
                                        background: var(--white);
                                        margin-top: 0 !important;
                                        padding-top: 8px;
                                        border-top: 1px solid var(--sand);
                                    }
                                    /* Currency Radio Styles */
                                    .currency-group {
                                        display: flex;
                                        gap: 12px;
                                    }
                                    .currency-option {
                                        flex: 1;
                                        position: relative;
                                    }
                                    .currency-option input {
                                        position: absolute;
                                        opacity: 0;
                                        width: 100%;
                                        height: 100%;
                                        cursor: pointer;
                                        z-index: 1;
                                    }
                                    .currency-option label {
                                        display: block;
                                        padding: 10px;
                                        text-align: center;
                                        background: var(--white);
                                        border: 1px solid var(--sand);
                                        border-radius: 12px;
                                        cursor: pointer;
                                        transition: all 0.2s;
                                        font-weight: 500;
                                        color: var(--text);
                                        font-size: 0.95rem;
                                    }
                                    .currency-option input:checked + label {
                                        background: var(--accent);
                                        color: var(--white);
                                        border-color: var(--accent);
                                    }
                                </style>
                                <div class="date-time-grid">
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--accent); font-size: 0.9rem;">Êó•Êúü</label>
                                        <input id="swal-date" type="date" class="swal2-input" value="${this.form.date}">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--accent); font-size: 0.9rem;">ÊôÇÈñì</label>
                                        <input id="swal-time" type="time" class="swal2-input" value="${this.form.time}">
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 4px;">
                                <label style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--accent); font-size: 0.9rem;">ÂêçÁ®±</label>
                                <input id="swal-name" type="text" class="swal2-input" placeholder="‰æãÂ¶ÇÔºöÂçàÈ§ê„ÄÅËªäÁ•®">
                            </div>

                                <div style="margin-bottom: 4px;">
                                <label style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--accent); font-size: 0.9rem;">Âπ£Âà•</label>
                                <div class="currency-group">
                                    <div class="currency-option">
                                        <input type="radio" name="swal-currency" id="curr-jpy" value="JPY" ${this.form.currency === 'JPY' ? 'checked' : ''}>
                                        <label for="curr-jpy">üáØüáµ Êó•Âúì (JPY)</label>
                                    </div>
                                    <div class="currency-option">
                                        <input type="radio" name="swal-currency" id="curr-twd" value="TWD" ${this.form.currency === 'TWD' ? 'checked' : ''}>
                                        <label for="curr-twd">üáπüáº Âè∞Âπ£ (TWD)</label>
                                    </div>
                                </div>
                            </div>

                                <div style="margin-bottom: 4px;">
                                <label style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--accent); font-size: 0.9rem;">ÈáëÈ°ç</label>
                                <input id="swal-amount" type="number" class="swal2-input" min="0" step="0.01" placeholder="0.00" readonly style="background-color: #f9f9f9;">
                                
                                <!-- Êï∏Â≠óÈçµÁõ§ -->
                                <div class="num-pad-grid" id="num-pad">
                                    <button type="button" class="num-btn" data-val="1">1</button>
                                    <button type="button" class="num-btn" data-val="2">2</button>
                                    <button type="button" class="num-btn" data-val="3">3</button>
                                    <button type="button" class="num-btn" data-val="4">4</button>
                                    <button type="button" class="num-btn" data-val="5">5</button>
                                    <button type="button" class="num-btn" data-val="6">6</button>
                                    <button type="button" class="num-btn" data-val="7">7</button>
                                    <button type="button" class="num-btn" data-val="8">8</button>
                                    <button type="button" class="num-btn" data-val="9">9</button>
                                    <button type="button" class="num-btn" data-val=".">.</button>
                                    <button type="button" class="num-btn" data-val="0">0</button>
                                    <button type="button" class="num-btn action-btn" data-action="backspace">‚å´</button>
                                </div>
                            </div>
                            </div>
                        `,
                        focusConfirm: false,
                        showCancelButton: true,
                        confirmButtonText: 'Êñ∞Â¢û',
                        cancelButtonText: 'ÂèñÊ∂à',
                        confirmButtonColor: '#4A2F1E',
                        cancelButtonColor: '#999',
                        width: '500px',
                        didOpen: () => {
                            // Á∂ÅÂÆöÊï∏Â≠óÈçµÁõ§‰∫ã‰ª∂
                            const amountInput = document.getElementById('swal-amount');
                            const numPad = document.getElementById('num-pad');

                            numPad.addEventListener('click', (e) => {
                                if (e.target.tagName !== 'BUTTON') return;

                                const btn = e.target;
                                const val = btn.dataset.val;
                                const action = btn.dataset.action;
                                const currentVal = amountInput.value;

                                if (action === 'backspace') {
                                    amountInput.value = currentVal.slice(0, -1);
                                } else if (val) {
                                    // Èò≤Ê≠¢Â§öÂÄãÂ∞èÊï∏Èªû
                                    if (val === '.' && currentVal.includes('.')) return;
                                    // ÈôêÂà∂Â∞èÊï∏ÈªûÂæåÂÖ©‰Ωç
                                    if (currentVal.includes('.') && currentVal.split('.')[1].length >= 2) return;

                                    // ÈôêÂà∂ÊúÄÂ§ßÈáëÈ°ç (99,999,999)
                                    const newVal = currentVal + val;
                                    if (parseFloat(newVal) > 99999999) return;

                                    amountInput.value = newVal;
                                }
                            });
                        },
                        preConfirm: () => {
                            const date = document.getElementById('swal-date').value;
                            const time = document.getElementById('swal-time').value;
                            const name = document.getElementById('swal-name').value;
                            const amount = document.getElementById('swal-amount').value;
                            // Áç≤ÂèñÈÅ∏‰∏≠ÁöÑ radio value
                            const currencyEl = document.querySelector('input[name="swal-currency"]:checked');
                            const currency = currencyEl ? currencyEl.value : 'JPY';

                            if (!date || !time || !name || !amount) {
                                Swal.showValidationMessage('Ë´ãÂ°´ÂØ´ÊâÄÊúâÊ¨Ñ‰Ωç');
                                return false;
                            }

                            return { date, time, name, amount, currency };
                        }
                    });

                    if (formValues) {
                        this.form.date = formValues.date;
                        this.form.time = formValues.time;
                        this.form.itemName = formValues.name;
                        this.form.amount = formValues.amount;
                        this.form.currency = formValues.currency;
                        await this.addExpense();
                    }
                },
                async addExpense() {
                    // È°ØÁ§∫ Loading
                    Swal.fire({
                        title: 'ÂÑ≤Â≠ò‰∏≠...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    this.loading = true;
                    try {
                        const result = await ExpenseAPI.create(
                            this.user.id,
                            this.form.date,
                            this.form.time,
                            this.form.itemName,
                            this.form.amount,
                            this.form.currency
                        );

                        if (result.success) {
                            // Âº∑Âà∂Âæû API ÈáçÊñ∞ËºâÂÖ•‰ª•Á¢∫‰øùË≥áÊñô‰∏ÄËá¥ÊÄß
                            await this.loadExpenses(true);
                            this.form.itemName = '';
                            this.form.amount = '';
                            this.setDefaultDateTime();

                            // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
                            Swal.fire({
                                icon: 'success',
                                title: 'Êñ∞Â¢ûÊàêÂäüÔºÅ',
                                text: 'Ë®òÂ∏≥Á¥ÄÈåÑÂ∑≤ÂÑ≤Â≠ò',
                                timer: 1500,
                                showConfirmButton: false
                            });
                        }
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Êñ∞Â¢ûÂ§±Êïó',
                            text: error.message
                        });
                    } finally {
                        this.loading = false;
                    }
                },
                async deleteExpense(id) {
                    // È°ØÁ§∫ Loading Toast
                    Swal.fire({
                        title: 'Âà™Èô§‰∏≠...',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    try {
                        const apiResult = await ExpenseAPI.delete(id);
                        if (apiResult.success) {
                            // Âº∑Âà∂Âæû API ÈáçÊñ∞ËºâÂÖ•‰ª•Á¢∫‰øùË≥áÊñô‰∏ÄËá¥ÊÄß
                            await this.loadExpenses(true);
                            // È°ØÁ§∫Ëá™ÂãïÊ∂àÂ§±ÁöÑÊàêÂäüË®äÊÅØ
                            Swal.fire({
                                icon: 'success',
                                title: 'Â∑≤Âà™Èô§',
                                showConfirmButton: false,
                                timer: 1000,
                                toast: true,
                                position: 'top-end'
                            });
                        }
                    } catch (error) {
                        console.error('Failed to delete expense:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Âà™Èô§Â§±Êïó',
                            text: 'ÁÑ°Ê≥ïÂà™Èô§Ë®òÂ∏≥Á¥ÄÈåÑÔºåË´ãÁ®çÂæåÂÜçË©¶'
                        });
                    }
                },
                handleTouchStart(e, id) {
                    this.touchStartX = e.touches[0].clientX;
                    this.touchStartY = e.touches[0].clientY;
                    this.currentTouchId = id;
                },
                handleTouchEnd(e) {
                    if (!this.currentTouchId) return;

                    const deltaX = e.changedTouches[0].clientX - this.touchStartX;
                    const deltaY = e.changedTouches[0].clientY - this.touchStartY;

                    // Âà§Êñ∑ÊòØÂê¶ÁÇ∫Ê∞¥Âπ≥ÊªëÂãïÔºàXËª∏ÁßªÂãïÂ§ßÊñºYËª∏Ôºâ‰∏îË∑ùÈõ¢Ë∂≥Â§†ÔºàÂ§ßÊñº50pxÔºâ
                    if (Math.abs(deltaX) > 50 && Math.abs(deltaX) > Math.abs(deltaY)) {
                        if (deltaX < 0) {
                            // ÂêëÂ∑¶ÊªëÔºåÈ°ØÁ§∫Âà™Èô§
                            this.activeSwipeId = this.currentTouchId;
                        } else {
                            // ÂêëÂè≥ÊªëÔºåÈóúÈñâ
                            if (this.activeSwipeId === this.currentTouchId) {
                                this.activeSwipeId = null;
                            }
                        }
                    }

                    this.currentTouchId = null;
                },
                handleItemClick(id) {
                    // ÈªûÊìäÈ†ÖÁõÆÊôÇÔºåÂ¶ÇÊûúË©≤È†ÖÁõÆÂ∑≤ÊªëÈñãÔºåÂâáÈóúÈñâ
                    // Â¶ÇÊûúÈªûÊìäÂÖ∂‰ªñÈ†ÖÁõÆÔºå‰∏îÊúâÈ†ÖÁõÆÊªëÈñãÔºå‰πüÈóúÈñâ
                    if (this.activeSwipeId) {
                        this.activeSwipeId = null;
                    }
                },
                logout() {
                    localStorage.removeItem('user');
                    // ÁôªÂá∫ÊôÇÊ∏ÖÈô§Âø´Âèñ
                    this.clearCache();
                    window.location.href = 'login.html?redirect=accounting.html';
                },
                formatDate(dateStr) {
                    return new Date(dateStr).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
                },
                formatDateFull(dateStr) {
                    return new Date(dateStr).toLocaleDateString('zh-TW', {
                        month: 'long',
                        day: 'numeric'
                    });
                },
                formatWeekday(dateStr) {
                    const weekdays = ['ÈÄ±Êó•', 'ÈÄ±‰∏Ä', 'ÈÄ±‰∫å', 'ÈÄ±‰∏â', 'ÈÄ±Âõõ', 'ÈÄ±‰∫î', 'ÈÄ±ÂÖ≠'];
                    return weekdays[new Date(dateStr).getDay()];
                },
                formatTime(timeStr) {
                    return timeStr.slice(0, 5);
                },
                formatNumber(num) {
                    return Number(num).toLocaleString();
                }
            }
        });
    </script>
</body>

</html>