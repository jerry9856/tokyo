<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¨˜å¸³ | æ±äº¬ 6 æ—¥</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- è¨˜å¸³é é¢å°ˆç”¨æ¨£å¼ -->
    <link rel="stylesheet" href="style/accounting.css">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>

<body>
    <div id="app" v-cloak>
        <!-- Navbar -->
        <nav class="sticky-nav nav-bottom">
            <div class="nav-pill">
                <a href="index.html" class="nav-item">é¦–é </a>
                <a href="weather.html" class="nav-item">å¤©æ°£</a>
                <a href="accounting.html" class="nav-item active">è¨˜å¸³</a>
            </div>
        </nav>

        <div class="accounting-container">
            <div class="user-info">
                <h1>æ—…è²»è¨˜å¸³</h1>
                <div v-if="user">
                    <button class="logout-btn" @click="logout">ç™»å‡º</button>
                </div>
            </div>

            <div class="header-controls">
                <div class="filters">
                    <select v-model="filterCurrency" class="filter-select">
                        <option value="ALL">æ‰€æœ‰å¹£åˆ¥</option>
                        <option value="JPY">ğŸ‡¯ğŸ‡µ æ—¥åœ“</option>
                        <option value="TWD">ğŸ‡¹ğŸ‡¼ å°å¹£</option>
                    </select>
                    <select v-model="filterPayer" class="filter-select">
                        <option value="ALL">æ‰€æœ‰ä»£ä»˜äºº</option>
                        <option v-for="payer in availablePayers" :key="payer" :value="payer">
                            {{ payer }}
                        </option>
                    </select>
                </div>
                <button class="refresh-btn" :class="{ refreshing: isRefreshing }" @click="refreshExpenses"
                    title="é‡æ–°è¼‰å…¥è¨˜å¸³è³‡æ–™">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                    <span class="refresh-text">é‡æ–°æ•´ç†</span>
                </button>
            </div>

            <!-- è¨˜å¸³åˆ—è¡¨ -->
            <div v-if="!isLoading && expenses.length > 0">
                <div v-for="(group, date) in expensesByDate" :key="date" class="day-group">
                    <!-- æ—¥æœŸæ¨™é¡Œ -->
                    <div class="day-header">
                        <div class="day-date">
                            <div class="day-date-main">{{ formatDateFull(date) }}</div>
                            <div class="day-date-weekday">{{ formatWeekday(date) }}</div>
                        </div>
                        <div class="day-count">{{ group.items.length }} ç­†</div>
                    </div>

                    <!-- è¨˜å¸³é …ç›® -->
                    <div class="expense-items">
                        <div v-for="expense in group.items" :key="expense.id" class="expense-item">
                            <div class="expense-info">
                                <div class="expense-time">{{ formatTime(expense.time) }}</div>
                                <div class="expense-details">
                                    <div class="expense-name">{{ expense.item_name }}</div>
                                    <div v-if="expense.payer_name" class="expense-payer">
                                        <span class="payer-badge">ä»£ä»˜: {{ expense.payer_name }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="expense-actions">
                                <div class="expense-amount"
                                    :class="expense.currency === 'TWD' ? 'currency-twd' : 'currency-jpy'">
                                    {{ expense.currency === 'TWD' ? 'NT$' : 'Â¥' }} {{ formatNumber(expense.amount) }}
                                </div>
                                <button class="delete-btn" @click="deleteExpense(expense.id)" title="åˆªé™¤">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path
                                            d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                        </path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ç•¶æ—¥ç¸½è¨ˆ -->
                    <div class="day-summary">
                        <div v-if="group.totalJPY > 0" class="summary-item">
                            <div class="summary-label">æ—¥åœ“ç¸½è¨ˆ</div>
                            <div class="summary-amount jpy">Â¥ {{ formatNumber(group.totalJPY) }}</div>
                        </div>
                        <div v-if="group.totalTWD > 0" class="summary-item">
                            <div class="summary-label">å°å¹£ç¸½è¨ˆ</div>
                            <div class="summary-amount twd">NT$ {{ formatNumber(group.totalTWD) }}</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Loading é®ç½© -->
            <div v-if="isLoading" class="loading-overlay">
                <div>
                    <div class="spinner"></div>
                    <div class="loading-text">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- ç©ºç‹€æ…‹ -->
            <div v-else-if="expenses.length === 0" class="day-group">
                <div class="empty-state">
                    ç›®å‰æ²’æœ‰è¨˜å¸³ç´€éŒ„
                </div>
            </div>
        </div>

        <!-- æ–°å¢è¨˜å¸³æŒ‰éˆ• (FAB) -->
        <button class="add-expense-btn" @click="showAddExpenseModal" title="æ–°å¢ä¸€ç­†è¨˜å¸³">
            +
        </button>
    </div>

    <!-- Vue 2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    <script src="js/api-service.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        new Vue({
            el: '#app',
            data: {
                user: null,
                loading: false,
                isLoading: false,
                isRefreshing: false,
                expenses: [],
                form: {
                    date: '',
                    time: '',
                    itemName: '',
                    amount: '',
                    currency: 'JPY',
                    payerName: ''
                },
                filterCurrency: 'ALL',
                filterPayer: 'ALL',
                // å¿«å–ç›¸é—œ
                cacheKey: 'accounting_expenses_cache',
                cacheExpireTime: 5 * 60 * 1000, // å¿«å–éæœŸæ™‚é–“ï¼š5åˆ†é˜
                isLoadingFromCache: false
            },
            mounted() {
                this.checkLogin();
                this.setDefaultDateTime();
            },
            computed: {
                /**
                 * æŒ‰æ—¥æœŸåˆ†çµ„çš„è¨˜å¸³è³‡æ–™
                 */
                expensesByDate() {
                    const grouped = {};

                    // éæ¿¾èˆ‡åˆ†çµ„
                    let filtered = this.expenses;

                    if (this.filterCurrency !== 'ALL') {
                        filtered = filtered.filter(e => e.currency === this.filterCurrency);
                    }

                    if (this.filterPayer !== 'ALL') {
                        filtered = filtered.filter(e => e.payer_name === this.filterPayer);
                    }

                    // æŒ‰æ—¥æœŸåˆ†çµ„
                    filtered.forEach(expense => {
                        const date = expense.date;
                        if (!grouped[date]) {
                            grouped[date] = {
                                items: [],
                                totalJPY: 0,
                                totalTWD: 0
                            };
                        }
                        grouped[date].items.push(expense);

                        // è¨ˆç®—ç¸½è¨ˆ
                        if (expense.currency === 'JPY') {
                            grouped[date].totalJPY += parseFloat(expense.amount);
                        } else if (expense.currency === 'TWD') {
                            grouped[date].totalTWD += parseFloat(expense.amount);
                        }
                    });

                    // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                    const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
                    const result = {};
                    sortedDates.forEach(date => {
                        result[date] = grouped[date];
                    });

                    return result;
                },
                /**
                 * å¯é¸çš„ä»£ä»˜äººåˆ—è¡¨ï¼ˆå¾æ­·å²ç´€éŒ„æå–ï¼‰
                 */
                availablePayers() {
                    const payers = new Set();
                    this.expenses.forEach(e => {
                        if (e.payer_name) payers.add(e.payer_name);
                    });
                    return Array.from(payers);
                }
            },
            methods: {
                checkLogin() {
                    const userStr = localStorage.getItem('user');
                    if (!userStr) {
                        window.location.href = 'login.html?redirect=accounting.html';
                        return;
                    }
                    this.user = JSON.parse(userStr);
                    this.loadExpenses();
                },
                setDefaultDateTime() {
                    const now = new Date();
                    this.form.date = now.toISOString().split('T')[0];
                    this.form.time = now.toTimeString().slice(0, 5);
                },
                async loadExpenses(forceRefresh = false) {
                    // å¿«å–å„ªå…ˆç­–ç•¥ï¼šå…ˆå¾å¿«å–è¼‰å…¥ï¼Œå†å¾ API æ›´æ–°
                    const cachedData = this.getCachedExpenses();

                    if (cachedData && !forceRefresh) {
                        // ä½¿ç”¨å¿«å–è³‡æ–™ç«‹å³é¡¯ç¤º
                        this.expenses = cachedData.data;
                        this.isLoadingFromCache = true;
                        console.log('ğŸ“¦ å¾å¿«å–è¼‰å…¥è¨˜å¸³è³‡æ–™');

                        // æª¢æŸ¥å¿«å–æ˜¯å¦éæœŸ
                        const cacheAge = Date.now() - cachedData.timestamp;
                        if (cacheAge < this.cacheExpireTime) {
                            console.log(`âœ… å¿«å–ä»ç„¶æœ‰æ•ˆ (${Math.round(cacheAge / 1000)}ç§’å‰)`);
                            // å¿«å–ä»ç„¶æœ‰æ•ˆï¼Œä½†ä»åœ¨èƒŒæ™¯æ›´æ–°
                        } else {
                            console.log(`âš ï¸ å¿«å–å·²éæœŸ (${Math.round(cacheAge / 1000)}ç§’å‰)`);
                        }
                    } else {
                        this.isLoading = true;
                    }

                    // å¾ API ç²å–æœ€æ–°è³‡æ–™ï¼ˆèƒŒæ™¯æ›´æ–°æˆ–é¦–æ¬¡è¼‰å…¥ï¼‰
                    try {
                        const result = await ExpenseAPI.getAll(this.user.id);
                        if (result.success) {
                            this.expenses = result.data;
                            // æ›´æ–°å¿«å–
                            this.saveCachedExpenses(result.data);
                            console.log('ğŸ”„ å·²å¾ API æ›´æ–°è¨˜å¸³è³‡æ–™ä¸¦å„²å­˜è‡³å¿«å–');
                        }
                    } catch (error) {
                        console.error('Failed to load expenses:', error);
                        // å¦‚æœæœ‰å¿«å–è³‡æ–™ï¼Œå‰‡ä½¿ç”¨å¿«å–è³‡æ–™ï¼Œä¸é¡¯ç¤ºéŒ¯èª¤
                        if (!cachedData) {
                            Swal.fire({
                                icon: 'error',
                                title: 'è¼‰å…¥å¤±æ•—',
                                text: 'ç„¡æ³•è¼‰å…¥è¨˜å¸³ç´€éŒ„ï¼Œè«‹ç¨å¾Œå†è©¦'
                            });
                        } else {
                            console.log('âš ï¸ API è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨å¿«å–è³‡æ–™');
                        }
                    } finally {
                        this.isLoading = false;
                        this.isLoadingFromCache = false;
                    }
                },
                /**
                 * å„²å­˜è¨˜å¸³è³‡æ–™è‡³å¿«å–
                 */
                saveCachedExpenses(data) {
                    try {
                        const cacheData = {
                            data: data,
                            timestamp: Date.now(),
                            userId: this.user.id
                        };
                        localStorage.setItem(this.cacheKey, JSON.stringify(cacheData));
                    } catch (error) {
                        console.error('Failed to save cache:', error);
                    }
                },
                /**
                 * å¾å¿«å–è®€å–è¨˜å¸³è³‡æ–™
                 */
                getCachedExpenses() {
                    try {
                        const cached = localStorage.getItem(this.cacheKey);
                        if (!cached) return null;

                        const cacheData = JSON.parse(cached);

                        // æª¢æŸ¥æ˜¯å¦ç‚ºåŒä¸€ä½¿ç”¨è€…çš„å¿«å–
                        if (cacheData.userId !== this.user.id) {
                            console.log('ğŸ”„ ä½¿ç”¨è€…å·²è®Šæ›´ï¼Œæ¸…é™¤èˆŠå¿«å–');
                            this.clearCache();
                            return null;
                        }

                        return cacheData;
                    } catch (error) {
                        console.error('Failed to read cache:', error);
                        return null;
                    }
                },
                /**
                 * æ¸…é™¤å¿«å–
                 */
                clearCache() {
                    try {
                        localStorage.removeItem(this.cacheKey);
                        console.log('ğŸ—‘ï¸ å·²æ¸…é™¤å¿«å–');
                    } catch (error) {
                        console.error('Failed to clear cache:', error);
                    }
                },
                /**
                 * æ‰‹å‹•åˆ·æ–°è¨˜å¸³è³‡æ–™
                 */
                async refreshExpenses() {
                    this.isRefreshing = true;
                    console.log('ğŸ”„ æ‰‹å‹•åˆ·æ–°è¨˜å¸³è³‡æ–™...');
                    try {
                        // å¼·åˆ¶å¾ API é‡æ–°è¼‰å…¥ï¼Œå¿½ç•¥å¿«å–
                        await this.loadExpenses(true);
                    } catch (error) {
                        console.error('Refresh failed:', error);
                    } finally {
                        // å»¶é²ä¸€é»å†ç§»é™¤å‹•ç•«ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°å®Œæ•´çš„æ—‹è½‰æ•ˆæœ
                        setTimeout(() => {
                            this.isRefreshing = false;
                        }, 500);
                    }
                },
                async showAddExpenseModal() {
                    this.setDefaultDateTime();

                    const { value: formValues } = await Swal.fire({
                        title: '',
                        html: `
                            <div style="text-align: left; font-size: 0.9rem;">
                                <style>
                                    .swal2-input {
                                        height: 2.2em !important;
                                        padding: 0 0.75em !important;
                                        font-size: 0.95rem !important;
                                        margin: 0 !important;
                                        width: 100% !important;
                                        box-sizing: border-box !important;
                                        max-width: 100% !important;
                                    }
                                    .date-time-grid {
                                        display: grid;
                                        grid-template-columns: 1fr 1fr;
                                        gap: 8px;
                                        margin-bottom: 12px;
                                    }
                                    .date-time-grid > div {
                                        min-width: 0;
                                    }
                                    @media (max-width: 500px) {
                                        .swal2-input {
                                            font-size: 0.85rem !important;
                                            padding: 0 0.5em !important;
                                        }
                                        .date-time-grid {
                                            grid-template-columns: 1fr;
                                            gap: 8px;
                                        }
                                    }
                                    .num-pad-grid {
                                        display: grid;
                                        grid-template-columns: repeat(3, 1fr);
                                        gap: 8px;
                                        margin-top: 8px;
                                    }
                                    .num-btn {
                                        padding: 10px;
                                        font-size: 1.2rem;
                                        font-weight: 500;
                                        border: 1px solid var(--sand);
                                        border-radius: 8px;
                                        background: var(--white);
                                        color: var(--accent);
                                        cursor: pointer;
                                        transition: background 0.1s;
                                        user-select: none;
                                    }
                                    .num-btn:active {
                                        background: var(--linen);
                                        transform: scale(0.98);
                                    }
                                    .num-btn.action-btn {
                                        background: var(--shell);
                                        font-size: 1rem;
                                    }
                                    .swal2-actions {
                                        position: sticky;
                                        bottom: 0;
                                        background: var(--white);
                                        margin-top: 0 !important;
                                        padding-top: 8px;
                                        border-top: 1px solid var(--sand);
                                    }
                                    /* Currency Radio Styles */
                                    .currency-group {
                                        display: flex;
                                        gap: 12px;
                                    }
                                    .currency-option {
                                        flex: 1;
                                        position: relative;
                                    }
                                    .currency-option input {
                                        position: absolute;
                                        opacity: 0;
                                        width: 100%;
                                        height: 100%;
                                        cursor: pointer;
                                        z-index: 1;
                                    }
                                    .currency-option label {
                                        display: block;
                                        padding: 10px;
                                        text-align: center;
                                        background: var(--white);
                                        border: 1px solid var(--sand);
                                        border-radius: 12px;
                                        cursor: pointer;
                                        transition: all 0.2s;
                                        font-weight: 500;
                                        color: var(--text);
                                        font-size: 0.95rem;
                                    }
                                    .currency-option input:checked + label {
                                        background: var(--accent);
                                        color: var(--white);
                                        border-color: var(--accent);
                                    }
                                </style>
                                <div class="date-time-grid">
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--accent); font-size: 0.9rem;">æ—¥æœŸ</label>
                                        <input id="swal-date" type="date" class="swal2-input" value="${this.form.date}">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--accent); font-size: 0.9rem;">æ™‚é–“</label>
                                        <input id="swal-time" type="time" class="swal2-input" value="${this.form.time}">
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 4px;">
                                <label style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--accent); font-size: 0.9rem;">åç¨±</label>
                                <input id="swal-name" type="text" class="swal2-input" placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€è»Šç¥¨">
                            </div>

                            <div style="margin-bottom: 4px;">
                                <label style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--accent); font-size: 0.9rem;">ä»£ä»˜äºº (é¸å¡«)</label>
                                <input id="swal-payer" type="text" class="swal2-input" list="payer-list" placeholder="èª°ä»˜çš„éŒ¢ï¼Ÿ" value="${this.form.payerName || ''}">
                                <datalist id="payer-list">
                                    ${this.availablePayers.map(p => `<option value="${p}">`).join('')}
                                </datalist>
                            </div>

                                <div style="margin-bottom: 4px;">
                                <label style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--accent); font-size: 0.9rem;">å¹£åˆ¥</label>
                                <div class="currency-group">
                                    <div class="currency-option">
                                        <input type="radio" name="swal-currency" id="curr-jpy" value="JPY" ${this.form.currency === 'JPY' ? 'checked' : ''}>
                                        <label for="curr-jpy">ğŸ‡¯ğŸ‡µ æ—¥åœ“ (JPY)</label>
                                    </div>
                                    <div class="currency-option">
                                        <input type="radio" name="swal-currency" id="curr-twd" value="TWD" ${this.form.currency === 'TWD' ? 'checked' : ''}>
                                        <label for="curr-twd">ğŸ‡¹ğŸ‡¼ å°å¹£ (TWD)</label>
                                    </div>
                                </div>
                            </div>

                                <div style="margin-bottom: 4px;">
                                <label style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--accent); font-size: 0.9rem;">é‡‘é¡</label>
                                <input id="swal-amount" type="number" class="swal2-input" min="0" step="0.01" placeholder="0.00" readonly style="background-color: #f9f9f9;">
                                
                                <!-- æ•¸å­—éµç›¤ -->
                                <div class="num-pad-grid" id="num-pad">
                                    <button type="button" class="num-btn" data-val="1">1</button>
                                    <button type="button" class="num-btn" data-val="2">2</button>
                                    <button type="button" class="num-btn" data-val="3">3</button>
                                    <button type="button" class="num-btn" data-val="4">4</button>
                                    <button type="button" class="num-btn" data-val="5">5</button>
                                    <button type="button" class="num-btn" data-val="6">6</button>
                                    <button type="button" class="num-btn" data-val="7">7</button>
                                    <button type="button" class="num-btn" data-val="8">8</button>
                                    <button type="button" class="num-btn" data-val="9">9</button>
                                    <button type="button" class="num-btn" data-val=".">.</button>
                                    <button type="button" class="num-btn" data-val="0">0</button>
                                    <button type="button" class="num-btn action-btn" data-action="backspace">âŒ«</button>
                                </div>
                            </div>
                            </div>
                        `,
                        focusConfirm: false,
                        showCancelButton: true,
                        confirmButtonText: 'æ–°å¢',
                        cancelButtonText: 'å–æ¶ˆ',
                        confirmButtonColor: '#4A2F1E',
                        cancelButtonColor: '#999',
                        width: '500px',
                        didOpen: () => {
                            // é˜²æ­¢ iPhone è‡ªå‹•æ‰“é–‹æ—¥æœŸé¸å–® - ä½¿ç”¨å»¶è¿Ÿçš„æ–¹å¼å½»åº•é˜»æ­¢
                            setTimeout(() => {
                                const dateInput = document.getElementById('swal-date');
                                const timeInput = document.getElementById('swal-time');
                                
                                if (dateInput) {
                                    dateInput.blur();
                                    // æš‚æ—¶ç¦ç”¨ï¼Œç‚¹å‡»æ—¶å†å¯ç”¨
                                    dateInput.setAttribute('readonly', 'readonly');
                                    dateInput.addEventListener('click', function enableEdit() {
                                        this.removeAttribute('readonly');
                                        this.removeEventListener('click', enableEdit);
                                    }, { once: true });
                                }
                                
                                if (timeInput) {
                                    timeInput.blur();
                                    timeInput.setAttribute('readonly', 'readonly');
                                    timeInput.addEventListener('click', function enableEdit() {
                                        this.removeAttribute('readonly');
                                        this.removeEventListener('click', enableEdit);
                                    }, { once: true });
                                }
                                
                                // ç§»é™¤æ‰€æœ‰è¼¸å…¥æ¡†çš„è‡ªå‹•èšç„¦
                                if (document.activeElement) {
                                    document.activeElement.blur();
                                }
                            }, 100);
                            
                            // ç¶å®šæ•¸å­—éµç›¤äº‹ä»¶
                            const amountInput = document.getElementById('swal-amount');
                            const numPad = document.getElementById('num-pad');

                            numPad.addEventListener('click', (e) => {
                                if (e.target.tagName !== 'BUTTON') return;

                                const btn = e.target;
                                const val = btn.dataset.val;
                                const action = btn.dataset.action;
                                const currentVal = amountInput.value;

                                if (action === 'backspace') {
                                    amountInput.value = currentVal.slice(0, -1);
                                } else if (val) {
                                    // é˜²æ­¢å¤šå€‹å°æ•¸é»
                                    if (val === '.' && currentVal.includes('.')) return;
                                    // é™åˆ¶å°æ•¸é»å¾Œå…©ä½
                                    if (currentVal.includes('.') && currentVal.split('.')[1].length >= 2) return;

                                    // é™åˆ¶æœ€å¤§é‡‘é¡ (99,999,999)
                                    const newVal = currentVal + val;
                                    if (parseFloat(newVal) > 99999999) return;

                                    amountInput.value = newVal;
                                }
                            });
                        },
                        preConfirm: () => {
                            const date = document.getElementById('swal-date').value;
                            const time = document.getElementById('swal-time').value;
                            const name = document.getElementById('swal-name').value;
                            const amount = document.getElementById('swal-amount').value;
                            const payerName = document.getElementById('swal-payer').value;
                            // ç²å–é¸ä¸­çš„ radio value
                            const currencyEl = document.querySelector('input[name="swal-currency"]:checked');
                            const currency = currencyEl ? currencyEl.value : 'JPY';

                            if (!date || !time || !name || !amount) {
                                Swal.showValidationMessage('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
                                return false;
                            }

                            return { date, time, name, amount, currency, payerName };
                        }
                    });

                    if (formValues) {
                        this.form.date = formValues.date;
                        this.form.time = formValues.time;
                        this.form.itemName = formValues.name;
                        this.form.amount = formValues.amount;
                        this.form.currency = formValues.currency;
                        this.form.payerName = formValues.payerName;
                        await this.addExpense();
                    }
                },
                async addExpense() {
                    // é¡¯ç¤º Loading
                    Swal.fire({
                        title: 'å„²å­˜ä¸­...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    this.loading = true;
                    try {
                        const result = await ExpenseAPI.create(
                            this.user.id,
                            this.form.date,
                            this.form.time,
                            this.form.itemName,
                            this.form.amount,
                            this.form.currency,
                            this.form.payerName
                        );

                        if (result.success) {
                            // å¼·åˆ¶å¾ API é‡æ–°è¼‰å…¥ä»¥ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§
                            await this.loadExpenses(true);
                            this.form.itemName = '';
                            this.form.amount = '';
                            // é€™è£¡ä¸æ¸…é™¤ payerNameï¼Œæ–¹ä¾¿ä¸‹æ¬¡ç¹¼çºŒä½¿ç”¨
                            this.setDefaultDateTime();

                            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                            Swal.fire({
                                icon: 'success',
                                title: 'æ–°å¢æˆåŠŸ',
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 2000,
                                timerProgressBar: true
                            });
                        }
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'æ–°å¢å¤±æ•—',
                            text: error.message
                        });
                    } finally {
                        this.loading = false;
                    }
                },
                async deleteExpense(id) {
                    // é¡¯ç¤º Loading Toast
                    Swal.fire({
                        title: 'åˆªé™¤ä¸­...',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    try {
                        const apiResult = await ExpenseAPI.delete(id);
                        if (apiResult.success) {
                            // å¼·åˆ¶å¾ API é‡æ–°è¼‰å…¥ä»¥ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§
                            await this.loadExpenses(true);
                            // é¡¯ç¤ºè‡ªå‹•æ¶ˆå¤±çš„æˆåŠŸè¨Šæ¯
                            Swal.fire({
                                icon: 'success',
                                title: 'å·²åˆªé™¤',
                                showConfirmButton: false,
                                timer: 1000,
                                toast: true,
                                position: 'top-end'
                            });
                        }
                    } catch (error) {
                        console.error('Failed to delete expense:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'åˆªé™¤å¤±æ•—',
                            text: 'ç„¡æ³•åˆªé™¤è¨˜å¸³ç´€éŒ„ï¼Œè«‹ç¨å¾Œå†è©¦'
                        });
                    }
                },
                logout() {
                    localStorage.removeItem('user');
                    // ç™»å‡ºæ™‚æ¸…é™¤å¿«å–
                    this.clearCache();
                    window.location.href = 'login.html?redirect=accounting.html';
                },
                formatDate(dateStr) {
                    return new Date(dateStr).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
                },
                formatDateFull(dateStr) {
                    return new Date(dateStr).toLocaleDateString('zh-TW', {
                        month: 'long',
                        day: 'numeric'
                    });
                },
                formatWeekday(dateStr) {
                    const weekdays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
                    return weekdays[new Date(dateStr).getDay()];
                },
                formatTime(timeStr) {
                    return timeStr.slice(0, 5);
                },
                formatNumber(num) {
                    return Number(num).toLocaleString();
                }
            }
        });
    </script>
</body>

</html>