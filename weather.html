<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂêÑÊôØÈªûÂ§©Ê∞£</title>
    <link rel="icon" href="icon.png" type="image/png" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>

<body class="weather-page">

    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="weather-header">
        <a href="index.html" class="weather-back-btn" aria-label="Back to Home">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
        </a>
        <div class="weather-title">ÂêÑÊôØÈªû‰∏ÄÈÄ±Â§©Ê∞£</div>
        <div id="date-scroller" class="weather-date-scroller"></div>
    </div>

    <div id="spot-list" class="weather-spot-list"></div>

    <div id="map"></div>
    <div class="map-note">Data source: Open-Meteo.com</div>

    <script>
        // 1. ÊôØÈªûÁ∂ìÁ∑ØÂ∫¶
        const spots = [
            { name: "Èå¶Á≥∏Áî∫ËªäÁ´ô", lat: 35.6965, lng: 139.8126 },
            { name: "Ëø™Â£´Â∞ºÊ®ÇÂúí", lat: 35.6329, lng: 139.8804 },
            { name: "Ê≤≥Âè£ÊπñËªäÁ´ô", lat: 35.4982, lng: 138.7686 },
            { name: "Â§ßÁü≥ÂÖ¨Âúí", lat: 35.5228, lng: 138.7455 },
            { name: "‰∏ãÂêâÁî∞ËªäÁ´ô", lat: 35.4977, lng: 138.8032 },
            { name: "Êñ∞ÂÄâÂ±±Ê∑∫ÈñìÁ•ûÁ§æ", lat: 35.5005, lng: 138.8014 },
            { name: "Êô¥Á©∫Â°î", lat: 35.7101, lng: 139.8107 },
            { name: "ÊæÄË∞∑SKY", lat: 35.6583, lng: 139.7023 },
        ];

        // Â§©Ê∞£‰ª£Á¢ºËΩâÊèõ
        function getWeatherByCode(code) {
            if (code === 0) return { label: "Êô¥Êúó", icon: "‚òÄÔ∏è" };
            if (code >= 1 && code <= 3) return { label: "Â§öÈõ≤", icon: "‚õÖ" };
            if (code >= 45 && code <= 48) return { label: "Èúß", icon: "üå´Ô∏è" };
            if (code >= 51 && code <= 67) return { label: "Èõ®", icon: "üåßÔ∏è" };
            if (code >= 71 && code <= 77) return { label: "Èõ™", icon: "‚ùÑÔ∏è" };
            if (code >= 80 && code <= 82) return { label: "Èô£Èõ®", icon: "üå¶Ô∏è" };
            if (code >= 85 && code <= 86) return { label: "Èô£Èõ™", icon: "üå®Ô∏è" };
            if (code >= 95) return { label: "Èõ∑Èõ®", icon: "‚õàÔ∏è" };
            return { label: "Êú™Áü•", icon: "‚ùì" };
        }

        // 2. ÂàùÂßãÂåñÂú∞Âúñ
        const map = L.map('map', {
            zoomControl: false // Move zoom control if needed, or keep default
        }).setView([35.505, 138.775], 13);

        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        let markersLayer = L.layerGroup().addTo(map);
        let globalForecastData = [];
        let currentDayIndex = 0;
        let selectedSpotName = localStorage.getItem('selectedSpotName') || spots[0].name;

        // 3. ÊäìÂèñË≥áÊñô
        async function fetchWeatherData() {
            const promises = spots.map(async (spot) => {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${spot.lat}&longitude=${spot.lng}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    return { name: spot.name, lat: spot.lat, lng: spot.lng, daily: data.daily };
                } catch (error) {
                    console.error(error); return null;
                }
            });
            const results = await Promise.all(promises);
            return results.filter(r => r !== null);
        }

        // 4. ËôïÁêÜÊï∏Êìö
        async function initApp() {
            const rawData = await fetchWeatherData();
            if (rawData.length === 0) {
                alert("ÁÑ°Ê≥ïÂèñÂæóË≥áÊñô"); document.getElementById('loading').style.display = 'none'; return;
            }

            const daysCount = rawData[0].daily.time.length;
            for (let i = 0; i < daysCount; i++) {
                const dateStr = rawData[0].daily.time[i];
                const dateObj = new Date(dateStr);
                const displayDate = (dateObj.getMonth() + 1) + "/" + dateObj.getDate();
                const dayOfWeek = ["ÈÄ±Êó•", "ÈÄ±‰∏Ä", "ÈÄ±‰∫å", "ÈÄ±‰∏â", "ÈÄ±Âõõ", "ÈÄ±‰∫î", "ÈÄ±ÂÖ≠"][dateObj.getDay()];
                const dayWeather = {};

                rawData.forEach(spotData => {
                    const code = spotData.daily.weathercode[i];
                    const wInfo = getWeatherByCode(code);
                    dayWeather[spotData.name] = {
                        lat: spotData.lat,
                        lng: spotData.lng,
                        icon: wInfo.icon,
                        tempMin: Math.round(spotData.daily.temperature_2m_min[i]),
                        tempMax: Math.round(spotData.daily.temperature_2m_max[i]),
                        pop: spotData.daily.precipitation_probability_max[i] || 0
                    };
                });
                globalForecastData.push({ displayDate, dayOfWeek, weatherData: dayWeather });
            }
            document.getElementById('loading').style.display = 'none';
            renderDateSelector();
            renderSpotList();
            updateMapMarkers(0);
        }

        // 5. Êó•ÊúüÈÅ∏ÂñÆ
        function renderDateSelector() {
            const container = document.getElementById('date-scroller');
            globalForecastData.forEach((day, index) => {
                const card = document.createElement('div');
                card.className = `weather-date-card ${index === 0 ? 'active' : ''}`;
                card.innerHTML = `<div class="weather-date-text">${day.displayDate}</div><div class="weather-day-text">${day.dayOfWeek}</div>`;
                card.addEventListener('click', () => {
                    document.querySelectorAll('.weather-date-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    currentDayIndex = index;
                    updateMapMarkers(index);
                });
                container.appendChild(card);
            });
        }

        // 5.1 ÊôØÈªûÈÅ∏ÂñÆ
        function renderSpotList() {
            const container = document.getElementById('spot-list');
            container.innerHTML = '';
            spots.forEach(spot => {
                const btn = document.createElement('div');
                btn.className = 'weather-spot-item';
                btn.dataset.spotName = spot.name;
                btn.textContent = spot.name;
                btn.addEventListener('click', () => {
                    // Toggle selection
                    if (selectedSpotName === spot.name) {
                        selectedSpotName = null;
                    } else {
                        selectedSpotName = spot.name;
                        map.setView([spot.lat, spot.lng], 14);
                    }
                    localStorage.setItem('selectedSpotName', selectedSpotName || '');
                    updateSpotListUI();
                    updateMapMarkers(currentDayIndex);
                });
                container.appendChild(btn);
            });
            updateSpotListUI();
        }

        function updateSpotListUI() {
            document.querySelectorAll('.weather-spot-item').forEach(btn => {
                if (btn.dataset.spotName === selectedSpotName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // 6. Êõ¥Êñ∞Ê®ôË®ò
        function updateMapMarkers(dayIndex) {
            markersLayer.clearLayers();
            const dayData = globalForecastData[dayIndex];

            Object.keys(dayData.weatherData).forEach(spotName => {
                const w = dayData.weatherData[spotName];
                const isSelected = (spotName === selectedSpotName);

                let icon;
                if (isSelected) {
                    icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `
                            <div class="weather-marker selected">
                                <div class="wm-location">${spotName}</div>
                                <div class="wm-icon">${w.icon}</div>
                                <div class="wm-temp">${w.tempMin}¬∞ ~ ${w.tempMax}¬∞C</div>
                                <div class="wm-rain">‚òî ÈôçÈõ® ${w.pop}%</div>
                            </div>
                        `,
                        iconSize: [140, 0],
                        iconAnchor: [70, 0]
                    });
                } else {
                    icon = L.divIcon({
                        className: 'simple-dot-marker',
                        html: '',
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    });
                }

                const marker = L.marker([w.lat, w.lng], { icon: icon });

                marker.on('click', function () {
                    selectedSpotName = spotName;
                    localStorage.setItem('selectedSpotName', selectedSpotName);
                    updateSpotListUI();
                    updateMapMarkers(currentDayIndex);
                    // map.setView([w.lat, w.lng], 14); // Optional: center on click
                });

                marker.addTo(markersLayer);
                if (isSelected) {
                    marker.setZIndexOffset(1000);
                }
            });
        }

        initApp();

    </script>
</body>

</html>